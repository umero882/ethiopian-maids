# Stripe Checkout Flow - Complete Diagram

Visual representation of the full checkout and subscription flow.

---

## ๐ Complete Flow Diagram

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           STRIPE CHECKOUT FLOW                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโ
โ  User    โ
โ Frontend โ
โโโโโโฌโโโโโโ
     โ
     โ 1. Click "Upgrade to Pro"
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ subscriptionService.js       โ
โ createCheckoutSession()      โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ 2. POST with:
     โ    - priceId
     โ    - userType (sponsor)
     โ    - planTier (pro)
     โ    - billingCycle (monthly)
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Supabase Edge Function: create-checkout-session              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  1. Verify JWT authentication                                   โ
โ  2. Check if customer exists in Stripe                          โ
โ  3. Create Stripe customer (if needed)                          โ
โ  4. Create checkout session with metadata                       โ
โ  5. Return session ID + URL                                     โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ 3. Returns:
     โ    { sessionId: "cs_test_...", url: "https://checkout.stripe.com/..." }
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Frontend                    โ
โ  Redirects to Stripe         โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ 4. User redirected to Stripe Checkout
     โ
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      STRIPE CHECKOUT PAGE                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โข Secure Stripe-hosted page                                      โ
โ  โข User enters payment details                                    โ
โ  โข Card: 4242 4242 4242 4242 (test)                              โ
โ  โข Stripe processes payment                                       โ
โโโโโโคโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ 5. Payment successful
     โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                                 โ                             โ
     โ 6a. User redirect               โ 6b. Webhook event          โ
     โ     (immediate)                 โ     (async)                โ
     โผ                                 โผ                             โ
โโโโโโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  Frontend            โ      โ  Stripe                          โ โ
โ  Success URL         โ      โ  Sends webhook event             โ โ
โโโโโโฌโโโโโโโโโโโโโโโโโโ      โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
     โ                             โ                                โ
     โ 7. Extract sessionId        โ 8. POST to webhook URL         โ
     โ    from URL params          โ    with signature              โ
     โ                             โ                                โ
     โผ                             โผ                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Frontend              โ    โ  Edge: stripe-webhook              โโ
โ handleCheckoutSuccess โ    โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ
โโโโโโฌโโโโโโโโโโโโโโโโโโโ    โ  1. Verify signature               โโ
     โ                       โ  2. Handle event type               โโ
     โ 9. POST with          โ  3. Create/update subscription      โโ
     โ    sessionId          โ  4. Return 200 OK                   โโ
     โ                       โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โผ                            โ                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                โ
โ  Edge: handle-checkout-success โโ 10. Both paths update          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโ     database                   โ
โ  1. Retrieve session from Stripeโโ                                โ
โ  2. Verify user ownership       โโ                                โ
โ  3. Create subscription in DB   โโ                                โ
โ  4. Return subscription         โโผ                                โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                                 โ
     โ                       โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
     โ 11. Success response  โ  Supabase Database               โ  โ
     โ                       โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ  โ
     โผ                       โ  subscriptions table:             โ  โ
โโโโโโโโโโโโโโโโโโโโโโโโ     โ  โข id                            โ  โ
โ  Frontend            โ     โ  โข user_id                       โ  โ
โ  Shows success       โโโโโโโ  โข plan_type: 'pro'             โ  โ
โ  Updates UI          โ     โ  โข status: 'active'              โ  โ
โ  Redirects to        โ     โ  โข stripe_subscription_id        โ  โ
โ  dashboard           โ     โ  โข amount, currency, etc.        โ  โ
โโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
                                                                    โ
                                                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    DATABASE IS NOW IN SYNC
```

---

## ๐ฏ Key Components

### Frontend (Already Built โ)
- Location: `src/services/subscriptionService.js`
- Calls edge functions via Supabase client
- Handles redirects and success states

### Edge Functions (Just Created โ)
1. **create-checkout-session** - Creates Stripe session
2. **stripe-webhook** - Handles async events
3. **handle-checkout-success** - Processes redirect

### Stripe (External)
- Hosts checkout page
- Processes payments
- Sends webhooks

### Database (Already Setup โ)
- `subscriptions` table
- Stores subscription data
- Updated by edge functions

---

## ๐ Security Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     SECURITY LAYERS                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. FRONTEND โ EDGE FUNCTION
   โโโโโโโโโโโโโโโโโโโโโโโโโ
   Request Headers:
   โ Authorization: Bearer JWT_TOKEN
   โ Content-Type: application/json

   Edge Function Verifies:
   โ JWT signature valid
   โ User authenticated
   โ User ID matches

2. STRIPE โ WEBHOOK
   โโโโโโโโโโโโโโโโ
   Request Headers:
   โ stripe-signature: signature_here

   Edge Function Verifies:
   โ Webhook signature valid
   โ Event from Stripe
   โ Not replay attack

3. DATABASE OPERATIONS
   โโโโโโโโโโโโโโโโโโโ
   โ RLS policies enforce user_id
   โ Only owner can read/update
   โ Service role for webhooks
```

---

## ๐ Data Flow

### Checkout Session Metadata

```javascript
// Sent to Stripe in create-checkout-session
{
  supabase_user_id: "uuid",
  user_type: "sponsor",
  plan_tier: "pro",
  billing_cycle: "monthly"
}

// Retrieved in webhook and success handler
// Used to create subscription in database
```

### Database Record Created

```sql
INSERT INTO subscriptions (
  user_id,                    -- From metadata
  plan_type,                  -- 'pro'
  plan_name,                  -- 'pro monthly'
  status,                     -- 'active'
  amount,                     -- From Stripe
  currency,                   -- From Stripe
  billing_period,             -- 'monthly'
  stripe_subscription_id,     -- From Stripe
  stripe_customer_id,         -- From Stripe
  start_date,                 -- Now
  end_date,                   -- 30 days from now
  metadata                    -- Additional data
);
```

---

## ๐ Webhook Events Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              STRIPE WEBHOOK EVENT TYPES                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. checkout.session.completed
   โโโโโโโโโโโโโโโโโโโโโโโโโโ
   Trigger: User completes payment
   Action: Create subscription in database

2. customer.subscription.created
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   Trigger: New subscription created
   Action: Update subscription details

3. customer.subscription.updated
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   Trigger: Subscription modified (plan change, renewal)
   Action: Update subscription in database

4. customer.subscription.deleted
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   Trigger: Subscription cancelled
   Action: Mark subscription as cancelled

5. invoice.paid
   โโโโโโโโโโโโ
   Trigger: Payment successful
   Action: Update subscription status to active

6. invoice.payment_failed
   โโโโโโโโโโโโโโโโโโโโโโโ
   Trigger: Payment failed
   Action: Update subscription status to past_due

All events โ stripe-webhook Edge Function โ Database update
```

---

## ๐ญ Customer Portal Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  CUSTOMER PORTAL ACCESS                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

User
  โ
  โ Click "Manage Subscription"
  โผ
Frontend
  โ
  โ Call createPortalSession()
  โผ
Edge Function: create-portal-session
  โ
  โ 1. Verify user authenticated
  โ 2. Get stripe_customer_id from DB
  โ 3. Create portal session with Stripe
  โ 4. Return portal URL
  โผ
Frontend
  โ
  โ Redirect to portal URL
  โผ
Stripe Customer Portal
  โ
  โ User can:
  โ โข Update payment methods
  โ โข View invoices
  โ โข Download receipts
  โ โข Cancel subscription
  โ โข View billing history
  โผ
Changes made โ Webhooks sent โ Database updated
```

---

## ๐ซ Cancellation Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   SUBSCRIPTION CANCELLATION                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Option A: Cancel Immediately
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
User โ Cancel โ Edge Function: cancel-subscription
  โ
  โ cancelImmediately: true
  โผ
Stripe: subscription.cancel()
  โ
  โผ
Database: status = 'cancelled'
  โ
  โผ
User loses access immediately


Option B: Cancel at Period End (Recommended)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
User โ Cancel โ Edge Function: cancel-subscription
  โ
  โ cancelImmediately: false
  โผ
Stripe: subscription.update({ cancel_at_period_end: true })
  โ
  โผ
Database: metadata.cancel_at_period_end = true
  โ
  โผ
User keeps access until end of billing period
  โ
  โผ
At period end โ Webhook: customer.subscription.deleted
  โ
  โผ
Database: status = 'cancelled'
```

---

## ๐งช Testing Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        TESTING FLOW                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. Development
   โโโโโโโโโโโ
   npm run dev
   โ http://localhost:5173
   โ Uses test Stripe keys
   โ Test card: 4242 4242 4242 4242

2. Local Edge Functions (Optional)
   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
   supabase start
   supabase functions serve
   โ http://localhost:54321/functions/v1/...

3. Deployed Edge Functions
   โโโโโโโโโโโโโโโโโโโโโโโ
   npm run supabase:deploy
   โ https://YOUR_PROJECT.supabase.co/functions/v1/...

4. Webhook Testing
   โโโโโโโโโโโโโโโ
   stripe listen --forward-to YOUR_WEBHOOK_URL
   stripe trigger checkout.session.completed

5. End-to-End Test
   โโโโโโโโโโโโโโโ
   โ Click "Upgrade"
   โ Enter test card
   โ Complete payment
   โ Verify subscription in DB
   โ Check logs: npm run supabase:logs
```

---

## ๐ Monitoring Flow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      MONITORING POINTS                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. Frontend
   โโโโโโโโ
   โข User clicks "Upgrade"
   โข Console logs
   โข Error boundary catches

2. Edge Functions
   โโโโโโโโโโโโโโ
   โข npm run supabase:logs
   โข Function execution time
   โข Error rates
   โข Success/failure counts

3. Stripe Dashboard
   โโโโโโโโโโโโโโโโโ
   โข https://dashboard.stripe.com/test/subscriptions
   โข Payment success rate
   โข Failed payments
   โข Webhook delivery status

4. Database
   โโโโโโโโ
   โข SELECT * FROM subscriptions
   โข Check status values
   โข Verify timestamps
   โข Monitor metadata

5. Alerts (Optional)
   โโโโโโโโโโโโโโโโโ
   โข Failed webhook deliveries
   โข High error rates
   โข Payment failures spike
   โข Unusual cancellation rate
```

---

## ๐ฏ Success Criteria

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    VERIFICATION CHECKLIST                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โก User can initiate checkout
โก Redirects to Stripe successfully
โก Payment processes correctly
โก Redirects back with session ID
โก Subscription appears in database with:
  โก Correct user_id
  โก Correct plan_type
  โก Status = 'active'
  โก Valid stripe_subscription_id
  โก Correct amount and currency
  โก Start and end dates set
โก Webhook events received and processed
โก User can access customer portal
โก User can cancel subscription
โก All edge function logs show success
โก No errors in Stripe dashboard
```

---

## ๐ Deployment Checklist

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    DEPLOYMENT CHECKLIST                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Pre-Deploy:
โก Supabase CLI installed
โก Logged in to Supabase
โก Project linked

Deploy:
โก Secrets set (STRIPE_SECRET_KEY)
โก Functions deployed (all 5)
โก Webhook configured in Stripe
โก Webhook secret set

Post-Deploy:
โก Test checkout flow
โก Verify database records
โก Check webhook delivery
โก Test portal access
โก Test cancellation
โก Monitor logs

Production:
โก Switch to live Stripe keys
โก Update webhook URL to production
โก Test with real card
โก Monitor for 24 hours
```

---

**Visual Guide Created**: 2025-10-12
**Status**: Complete reference for full checkout flow
**Use**: Debugging, onboarding, documentation
