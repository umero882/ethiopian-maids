<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Upload Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .error {
        color: red;
        background: #ffe6e6;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .success {
        color: green;
        background: #e6ffe6;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .file-info {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      input[type='file'] {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>Image Upload Validation Test</h1>
    <p>
      This page tests the image validation functionality to ensure the
      "undefined photo format" error is fixed.
    </p>

    <div class="test-section">
      <h2>Test Image Upload</h2>
      <input
        type="file"
        id="imageInput"
        accept="image/jpeg,image/jpg,image/png,image/webp"
        multiple
      />
      <button onclick="testImageValidation()">Test Validation</button>
      <button onclick="clearResults()">Clear Results</button>
      <div id="results"></div>
    </div>

    <div class="test-section">
      <h2>Test Cases</h2>
      <p>Try uploading:</p>
      <ul>
        <li>‚úÖ Valid JPEG/JPG images</li>
        <li>‚úÖ Valid PNG images</li>
        <li>‚úÖ Valid WebP images</li>
        <li>‚ùå Non-image files (PDF, TXT, etc.)</li>
        <li>‚ùå Very large files (>5MB)</li>
        <li>‚ùå Empty files</li>
        <li>‚ùå Corrupted image files</li>
      </ul>
    </div>

    <script>
      // Simulate the validateImageFile function from our utils
      async function validateImageFile(file, options = {}) {
        const {
          maxSizeMB = 5,
          allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'],
          minWidth = 200,
          minHeight = 200,
          validateDimensions = false,
        } = options;

        // Check if file exists
        if (!file) {
          return { isValid: false, error: 'No file provided' };
        }

        // Check if file has required properties
        if (!file.name) {
          return { isValid: false, error: 'File must have a name' };
        }

        if (file.size === undefined || file.size === null) {
          return { isValid: false, error: 'File size information is missing' };
        }

        // Check file type - handle undefined/null file.type
        if (!file.type || file.type === '') {
          return {
            isValid: false,
            error:
              'File type could not be determined. Please ensure you are uploading a valid image file (JPEG, JPG, PNG, or WebP).',
          };
        }

        // Normalize file type for comparison (handle case variations)
        const normalizedFileType = file.type.toLowerCase();
        const normalizedAllowedTypes = allowedTypes.map((type) =>
          type.toLowerCase()
        );

        if (!normalizedAllowedTypes.includes(normalizedFileType)) {
          // Get file extension for additional context
          const fileExtension = file.name.toLowerCase().split('.').pop();
          const supportedExtensions = ['jpg', 'jpeg', 'png', 'webp'];

          if (supportedExtensions.includes(fileExtension)) {
            return {
              isValid: false,
              error: `File type mismatch. The file appears to be a ${fileExtension.toUpperCase()} but the browser detected it as "${file.type}". Please try re-saving the image or using a different file.`,
            };
          }

          return {
            isValid: false,
            error: `Unsupported file format "${file.type}". Please upload JPEG, JPG, PNG, or WebP images only.`,
          };
        }

        // Check file size
        const fileSizeMB = file.size / (1024 * 1024);
        if (fileSizeMB > maxSizeMB) {
          return {
            isValid: false,
            error: `File size too large (${fileSizeMB.toFixed(2)}MB). Maximum allowed size: ${maxSizeMB}MB`,
          };
        }

        // Check for minimum file size (avoid empty files)
        if (file.size < 100) {
          return {
            isValid: false,
            error:
              'File appears to be empty or corrupted. Please select a valid image file.',
          };
        }

        return { isValid: true, error: null };
      }

      async function testImageValidation() {
        const input = document.getElementById('imageInput');
        const results = document.getElementById('results');

        if (!input.files || input.files.length === 0) {
          results.innerHTML =
            '<div class="error">Please select at least one file to test.</div>';
          return;
        }

        results.innerHTML = '<h3>Validation Results:</h3>';

        for (let i = 0; i < input.files.length; i++) {
          const file = input.files[i];

          // Display file info
          const fileInfo = document.createElement('div');
          fileInfo.className = 'file-info';
          fileInfo.innerHTML = `
                    <strong>File ${i + 1}:</strong><br>
                    Name: ${file.name}<br>
                    Type: ${file.type || 'undefined'}<br>
                    Size: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    Last Modified: ${new Date(file.lastModified).toLocaleString()}
                `;
          results.appendChild(fileInfo);

          // Validate file
          try {
            const validation = await validateImageFile(file);

            const resultDiv = document.createElement('div');
            if (validation.isValid) {
              resultDiv.className = 'success';
              resultDiv.innerHTML = `‚úÖ <strong>Valid:</strong> ${file.name} passed validation`;
            } else {
              resultDiv.className = 'error';
              resultDiv.innerHTML = `‚ùå <strong>Invalid:</strong> ${validation.error}`;
            }
            results.appendChild(resultDiv);
          } catch (error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.innerHTML = `üí• <strong>Validation Error:</strong> ${error.message}`;
            results.appendChild(errorDiv);
          }
        }
      }

      function clearResults() {
        document.getElementById('results').innerHTML = '';
        document.getElementById('imageInput').value = '';
      }

      // Test with simulated undefined file type
      function testUndefinedFileType() {
        const mockFile = {
          name: 'test.jpg',
          size: 1024 * 1024, // 1MB
          type: undefined, // This simulates the issue
          lastModified: Date.now(),
        };

        validateImageFile(mockFile).then((result) => {
          const results = document.getElementById('results');
          const testDiv = document.createElement('div');
          testDiv.innerHTML = '<h3>Undefined File Type Test:</h3>';

          if (result.isValid) {
            testDiv.innerHTML +=
              '<div class="success">‚úÖ Test passed unexpectedly</div>';
          } else {
            testDiv.innerHTML += `<div class="error">‚ùå Expected error: ${result.error}</div>`;
          }

          results.appendChild(testDiv);
        });
      }

      // Add test button for undefined file type
      window.addEventListener('load', () => {
        const testSection = document.querySelector('.test-section');
        const undefinedTestBtn = document.createElement('button');
        undefinedTestBtn.textContent = 'Test Undefined File Type';
        undefinedTestBtn.onclick = testUndefinedFileType;
        testSection.appendChild(undefinedTestBtn);
      });
    </script>
  </body>
</html>
