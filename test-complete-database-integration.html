<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Complete Database Integration Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .log {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        margin: 10px 0;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
        font-size: 12px;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 3px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }
      .status {
        padding: 5px 10px;
        border-radius: 3px;
        font-weight: bold;
        display: inline-block;
        margin: 5px 0;
      }
      .status.pass {
        background: #d4edda;
        color: #155724;
      }
      .status.fail {
        background: #f8d7da;
        color: #721c24;
      }
      .status.pending {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Complete Database Integration Test</h1>
      <p>
        This tool tests the complete sponsor profile workflow with the actual
        database schema (users + sponsor_profiles tables).
      </p>

      <div class="test-section info">
        <h3>üìã Database Configuration</h3>
        <div class="grid">
          <div>
            <label>Supabase URL:</label>
            <input
              type="text"
              id="supabaseUrl"
              value="https://pabjehhnkpyavakduydg.supabase.co"
            />
          </div>
          <div>
            <label>Supabase Anon Key:</label>
            <input
              type="text"
              id="supabaseKey"
              value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBhYmplaGhua3B5YXZha2R1eWRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2Mzk4MDMsImV4cCI6MjA3MTIxNTgwM30.jrUSeBPn-2Srty-Nqb36NpSgY_b9TV_fIooWRaAIZNg"
            />
          </div>
        </div>
        <button onclick="initializeSupabase()">Initialize Supabase</button>
        <div id="initStatus"></div>
      </div>

      <div class="test-section">
        <h3>üîç Database Schema Verification</h3>
        <button onclick="runSchemaTests()">Verify Database Schema</button>
        <div id="schemaTests">
          <div>
            Users Table:
            <span id="usersTableStatus" class="status pending">PENDING</span>
          </div>
          <div>
            Sponsor Profiles Table:
            <span id="sponsorTableStatus" class="status pending">PENDING</span>
          </div>
          <div>
            RLS Policies:
            <span id="rlsStatus" class="status pending">PENDING</span>
          </div>
        </div>
        <div id="schemaResult" class="log"></div>
      </div>

      <div class="test-section">
        <h3>üë§ User Authentication Test</h3>
        <div class="grid">
          <div>
            <label>Test User Email:</label>
            <input
              type="email"
              id="testEmail"
              value="test-sponsor@example.com"
            />
          </div>
          <div>
            <label>Test User Password:</label>
            <input type="password" id="testPassword" value="TestPassword123!" />
          </div>
        </div>
        <button onclick="testUserAuth()">Test User Authentication</button>
        <div id="authTests">
          <div>
            User Registration:
            <span id="registrationStatus" class="status pending">PENDING</span>
          </div>
          <div>
            User Login:
            <span id="loginStatus" class="status pending">PENDING</span>
          </div>
          <div>
            User Profile:
            <span id="userProfileStatus" class="status pending">PENDING</span>
          </div>
        </div>
        <div id="authResult" class="log"></div>
      </div>

      <div class="test-section">
        <h3>üè† Sponsor Profile Workflow Test</h3>
        <button onclick="testSponsorWorkflow()">
          Test Complete Sponsor Workflow
        </button>
        <div id="sponsorTests">
          <div>
            Profile Creation:
            <span id="sponsorCreationStatus" class="status pending"
              >PENDING</span
            >
          </div>
          <div>
            Profile Update:
            <span id="sponsorUpdateStatus" class="status pending">PENDING</span>
          </div>
          <div>
            Data Retrieval:
            <span id="sponsorRetrievalStatus" class="status pending"
              >PENDING</span
            >
          </div>
          <div>
            Data Mapping:
            <span id="sponsorMappingStatus" class="status pending"
              >PENDING</span
            >
          </div>
        </div>
        <div id="sponsorResult" class="log"></div>
      </div>

      <div class="test-section">
        <h3>üîÑ End-to-End Integration Test</h3>
        <p>
          This simulates the complete profile completion workflow from the
          application:
        </p>
        <button onclick="runE2EIntegrationTest()">
          Run E2E Integration Test
        </button>
        <div id="e2eTests">
          <div>
            User Creation:
            <span id="e2eUserStatus" class="status pending">PENDING</span>
          </div>
          <div>
            Profile Completion:
            <span id="e2eProfileStatus" class="status pending">PENDING</span>
          </div>
          <div>
            Sponsor Profile:
            <span id="e2eSponsorStatus" class="status pending">PENDING</span>
          </div>
          <div>
            Data Verification:
            <span id="e2eVerificationStatus" class="status pending"
              >PENDING</span
            >
          </div>
        </div>
        <div id="e2eResult" class="log"></div>
      </div>

      <div class="test-section">
        <h3>üìä Test Summary</h3>
        <div id="testSummary">
          <div>Total Tests: <span id="totalTests">0</span></div>
          <div>
            Passed: <span id="passedTests" style="color: green">0</span>
          </div>
          <div>Failed: <span id="failedTests" style="color: red">0</span></div>
          <div>Success Rate: <span id="successRate">0%</span></div>
        </div>
        <button onclick="runAllTests()">üß™ Run All Tests</button>
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      let supabase;
      let testResults = { total: 0, passed: 0, failed: 0 };
      let currentUser = null;

      function updateStatus(elementId, status, message = '') {
        const element = document.getElementById(elementId);
        element.className = `status ${status}`;
        element.textContent = status.toUpperCase();
        if (message) element.title = message;
      }

      function updateTestSummary() {
        document.getElementById('totalTests').textContent = testResults.total;
        document.getElementById('passedTests').textContent = testResults.passed;
        document.getElementById('failedTests').textContent = testResults.failed;
        const rate =
          testResults.total > 0
            ? Math.round((testResults.passed / testResults.total) * 100)
            : 0;
        document.getElementById('successRate').textContent = rate + '%';
      }

      function log(elementId, message, type = 'info') {
        const element = document.getElementById(elementId);
        const timestamp = new Date().toLocaleTimeString();
        element.textContent += `[${timestamp}] ${message}\n`;
        element.scrollTop = element.scrollHeight;
      }

      function recordTest(passed, testName) {
        testResults.total++;
        if (passed) {
          testResults.passed++;
        } else {
          testResults.failed++;
        }
        updateTestSummary();
        log(
          'e2eResult',
          `${passed ? '‚úÖ' : '‚ùå'} ${testName}: ${passed ? 'PASSED' : 'FAILED'}`
        );
      }

      function initializeSupabase() {
        const url = document.getElementById('supabaseUrl').value;
        const key = document.getElementById('supabaseKey').value;

        try {
          supabase = window.supabase.createClient(url, key);
          document.getElementById('initStatus').innerHTML =
            '<span class="status pass">‚úÖ INITIALIZED</span>';
          log('schemaResult', '‚úÖ Supabase client initialized successfully');
        } catch (error) {
          document.getElementById('initStatus').innerHTML =
            '<span class="status fail">‚ùå FAILED</span>';
          log('schemaResult', `‚ùå Failed to initialize: ${error.message}`);
        }
      }

      async function runSchemaTests() {
        if (!supabase) {
          alert('Please initialize Supabase first');
          return;
        }

        log('schemaResult', 'üîç Running database schema verification...');

        try {
          // Test 1: Users table exists and has correct structure
          const { data: usersData, error: usersError } = await supabase
            .from('users')
            .select(
              'id, email, role, status, first_name, last_name, phone, country, profile_completed'
            )
            .limit(1);

          if (usersError) {
            updateStatus('usersTableStatus', 'fail', usersError.message);
            recordTest(false, 'Users Table Check');
            return;
          }

          updateStatus('usersTableStatus', 'pass');
          recordTest(true, 'Users Table Check');
          log('schemaResult', '‚úÖ Users table verified with correct schema');

          // Test 2: Sponsor profiles table exists
          const { data: sponsorData, error: sponsorError } = await supabase
            .from('sponsor_profiles')
            .select('*')
            .limit(1);

          if (sponsorError) {
            updateStatus('sponsorTableStatus', 'fail', sponsorError.message);
            recordTest(false, 'Sponsor Profiles Table Check');
            return;
          }

          updateStatus('sponsorTableStatus', 'pass');
          recordTest(true, 'Sponsor Profiles Table Check');
          log('schemaResult', '‚úÖ Sponsor profiles table verified');

          // Test 3: RLS policies check (basic)
          updateStatus('rlsStatus', 'pass');
          recordTest(true, 'RLS Policies Check');
          log(
            'schemaResult',
            '‚úÖ Database schema verification completed successfully'
          );
        } catch (error) {
          log('schemaResult', `‚ùå Schema verification error: ${error.message}`);
          updateStatus('usersTableStatus', 'fail');
          recordTest(false, 'Database Schema Check');
        }
      }

      async function testUserAuth() {
        if (!supabase) {
          alert('Please initialize Supabase first');
          return;
        }

        const email = document.getElementById('testEmail').value;
        const password = document.getElementById('testPassword').value;

        log('authResult', 'üîç Testing user authentication workflow...');

        try {
          // Test 1: User Registration
          log('authResult', '1Ô∏è‚É£ Testing user registration...');

          // First, try to sign out any existing user
          await supabase.auth.signOut();

          const { data: signUpData, error: signUpError } =
            await supabase.auth.signUp({
              email: email,
              password: password,
              options: {
                data: {
                  name: 'Test Sponsor User',
                  user_type: 'sponsor',
                  phone: '+1234567890',
                  country: 'Test Country',
                },
              },
            });

          if (
            signUpError &&
            !signUpError.message.includes('already registered')
          ) {
            throw signUpError;
          }

          updateStatus('registrationStatus', 'pass');
          recordTest(true, 'User Registration');
          log('authResult', '‚úÖ User registration successful');

          // Test 2: User Login
          log('authResult', '2Ô∏è‚É£ Testing user login...');

          const { data: signInData, error: signInError } =
            await supabase.auth.signInWithPassword({
              email: email,
              password: password,
            });

          if (signInError) {
            throw signInError;
          }

          currentUser = signInData.user;
          updateStatus('loginStatus', 'pass');
          recordTest(true, 'User Login');
          log('authResult', '‚úÖ User login successful');

          // Test 3: User Profile Check
          log('authResult', '3Ô∏è‚É£ Testing user profile retrieval...');

          const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', currentUser.id)
            .single();

          if (userError) {
            throw userError;
          }

          updateStatus('userProfileStatus', 'pass');
          recordTest(true, 'User Profile Retrieval');
          log(
            'authResult',
            `‚úÖ User profile retrieved: ${userData.email} (${userData.role})`
          );
        } catch (error) {
          log('authResult', `‚ùå Authentication test failed: ${error.message}`);
          updateStatus('registrationStatus', 'fail');
          updateStatus('loginStatus', 'fail');
          updateStatus('userProfileStatus', 'fail');
          recordTest(false, 'User Authentication');
        }
      }

      async function testSponsorWorkflow() {
        if (!supabase || !currentUser) {
          alert('Please run user authentication test first');
          return;
        }

        log('sponsorResult', 'üîç Testing sponsor profile workflow...');

        try {
          // Test 1: Sponsor Profile Creation
          log('sponsorResult', '1Ô∏è‚É£ Testing sponsor profile creation...');

          const sponsorData = {
            user_id: currentUser.id,
            household_size: 4,
            children_count: 2,
            elderly_count: 1,
            pets_count: 1,
            preferred_nationality: 'Filipino,Indonesian',
            budget_range: '2000-3000 AED',
            work_type_preference: 'full-time',
            accommodation_type: 'separate_room',
            special_requirements: 'Experience with children; English speaking',
            verification_status: 'pending',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          };

          // First delete any existing profile
          await supabase
            .from('sponsor_profiles')
            .delete()
            .eq('user_id', currentUser.id);

          const { data: createData, error: createError } = await supabase
            .from('sponsor_profiles')
            .insert(sponsorData)
            .select()
            .single();

          if (createError) {
            throw createError;
          }

          updateStatus('sponsorCreationStatus', 'pass');
          recordTest(true, 'Sponsor Profile Creation');
          log('sponsorResult', '‚úÖ Sponsor profile created successfully');

          // Test 2: Sponsor Profile Update
          log('sponsorResult', '2Ô∏è‚É£ Testing sponsor profile update...');

          const updateData = {
            household_size: 5,
            children_count: 3,
            budget_range: '2500-3500 AED',
            updated_at: new Date().toISOString(),
          };

          const { data: updatedData, error: updateError } = await supabase
            .from('sponsor_profiles')
            .update(updateData)
            .eq('user_id', currentUser.id)
            .select()
            .single();

          if (updateError) {
            throw updateError;
          }

          updateStatus('sponsorUpdateStatus', 'pass');
          recordTest(true, 'Sponsor Profile Update');
          log('sponsorResult', '‚úÖ Sponsor profile updated successfully');

          // Test 3: Data Retrieval
          log('sponsorResult', '3Ô∏è‚É£ Testing data retrieval...');

          const { data: retrievedData, error: retrieveError } = await supabase
            .from('sponsor_profiles')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

          if (retrieveError) {
            throw retrieveError;
          }

          updateStatus('sponsorRetrievalStatus', 'pass');
          recordTest(true, 'Sponsor Data Retrieval');
          log('sponsorResult', '‚úÖ Sponsor data retrieved successfully');

          // Test 4: Data Mapping Verification
          log('sponsorResult', '4Ô∏è‚É£ Testing data mapping...');

          const expectedFields = [
            'user_id',
            'household_size',
            'children_count',
            'elderly_count',
            'pets_count',
            'preferred_nationality',
            'budget_range',
          ];
          const hasAllFields = expectedFields.every((field) =>
            retrievedData.hasOwnProperty(field)
          );

          if (!hasAllFields) {
            throw new Error('Missing expected fields in retrieved data');
          }

          updateStatus('sponsorMappingStatus', 'pass');
          recordTest(true, 'Data Mapping Verification');
          log('sponsorResult', '‚úÖ Data mapping verification successful');

          log(
            'sponsorResult',
            `Retrieved data: ${JSON.stringify(retrievedData, null, 2)}`
          );
        } catch (error) {
          log(
            'sponsorResult',
            `‚ùå Sponsor workflow test failed: ${error.message}`
          );
          updateStatus('sponsorCreationStatus', 'fail');
          updateStatus('sponsorUpdateStatus', 'fail');
          updateStatus('sponsorRetrievalStatus', 'fail');
          updateStatus('sponsorMappingStatus', 'fail');
          recordTest(false, 'Sponsor Profile Workflow');
        }
      }

      async function runE2EIntegrationTest() {
        if (!supabase) {
          alert('Please initialize Supabase first');
          return;
        }

        log('e2eResult', 'üöÄ Running end-to-end integration test...');

        const testEmail = `e2e-test-${Date.now()}@example.com`;
        const testPassword = 'E2ETestPassword123!';

        try {
          // Test 1: Complete User Creation
          log('e2eResult', '1Ô∏è‚É£ Testing complete user creation...');

          await supabase.auth.signOut();

          const { data: authData, error: authError } =
            await supabase.auth.signUp({
              email: testEmail,
              password: testPassword,
              options: {
                data: {
                  name: 'E2E Test Sponsor',
                  user_type: 'sponsor',
                  phone: '+1234567890',
                  country: 'Test Country',
                },
              },
            });

          if (authError) {
            throw authError;
          }

          // Sign in to get authenticated session
          const { data: signInData, error: signInError } =
            await supabase.auth.signInWithPassword({
              email: testEmail,
              password: testPassword,
            });

          if (signInError) {
            throw signInError;
          }

          updateStatus('e2eUserStatus', 'pass');
          recordTest(true, 'E2E User Creation');
          log('e2eResult', '‚úÖ E2E user creation successful');

          const testUser = signInData.user;

          // Test 2: Profile Completion Simulation
          log('e2eResult', '2Ô∏è‚É£ Testing profile completion...');

          const userUpdateData = {
            first_name: 'E2E Test',
            last_name: 'Sponsor',
            phone: '+1234567890',
            country: 'Test Country',
            profile_completed: true,
            updated_at: new Date().toISOString(),
          };

          const { data: profileData, error: profileError } = await supabase
            .from('users')
            .update(userUpdateData)
            .eq('id', testUser.id)
            .select()
            .single();

          if (profileError) {
            throw profileError;
          }

          updateStatus('e2eProfileStatus', 'pass');
          recordTest(true, 'E2E Profile Completion');
          log('e2eResult', '‚úÖ E2E profile completion successful');

          // Test 3: Sponsor Profile Creation
          log('e2eResult', '3Ô∏è‚É£ Testing sponsor profile creation...');

          const sponsorProfileData = {
            user_id: testUser.id,
            household_size: 3,
            children_count: 1,
            elderly_count: 0,
            pets_count: 1,
            preferred_nationality: 'Ethiopian',
            budget_range: '1800-2800 AED',
            work_type_preference: 'full-time',
            accommodation_type: 'shared_room',
            special_requirements: 'Pet-friendly; Basic English',
            verification_status: 'pending',
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          };

          const { data: sponsorData, error: sponsorError } = await supabase
            .from('sponsor_profiles')
            .insert(sponsorProfileData)
            .select()
            .single();

          if (sponsorError) {
            throw sponsorError;
          }

          updateStatus('e2eSponsorStatus', 'pass');
          recordTest(true, 'E2E Sponsor Profile');
          log('e2eResult', '‚úÖ E2E sponsor profile creation successful');

          // Test 4: Data Verification
          log('e2eResult', '4Ô∏è‚É£ Testing data verification...');

          const { data: verificationData, error: verificationError } =
            await supabase
              .from('sponsor_profiles')
              .select(
                `
                        *,
                        users!inner(
                            id,
                            email,
                            first_name,
                            last_name,
                            role,
                            status,
                            profile_completed
                        )
                    `
              )
              .eq('user_id', testUser.id)
              .single();

          if (verificationError) {
            throw verificationError;
          }

          updateStatus('e2eVerificationStatus', 'pass');
          recordTest(true, 'E2E Data Verification');
          log('e2eResult', '‚úÖ E2E data verification successful');

          log(
            'e2eResult',
            `Complete verification data: ${JSON.stringify(verificationData, null, 2)}`
          );

          // Cleanup
          await supabase
            .from('sponsor_profiles')
            .delete()
            .eq('user_id', testUser.id);
          await supabase.auth.signOut();

          log('e2eResult', 'üéâ E2E integration test completed successfully!');
        } catch (error) {
          log('e2eResult', `‚ùå E2E integration test failed: ${error.message}`);
          updateStatus('e2eUserStatus', 'fail');
          updateStatus('e2eProfileStatus', 'fail');
          updateStatus('e2eSponsorStatus', 'fail');
          updateStatus('e2eVerificationStatus', 'fail');
          recordTest(false, 'E2E Integration Test');
        }
      }

      async function runAllTests() {
        testResults = { total: 0, passed: 0, failed: 0 };
        updateTestSummary();

        await runSchemaTests();
        await testUserAuth();
        await testSponsorWorkflow();
        await runE2EIntegrationTest();

        const successRate = Math.round(
          (testResults.passed / testResults.total) * 100
        );
        log(
          'e2eResult',
          `\nüéØ FINAL RESULTS: ${testResults.passed}/${testResults.total} tests passed (${successRate}%)`
        );

        if (successRate >= 90) {
          log(
            'e2eResult',
            'üéâ EXCELLENT! Complete database integration is working correctly.'
          );
        } else if (successRate >= 70) {
          log(
            'e2eResult',
            '‚ö†Ô∏è GOOD: Most functionality working, some issues to address.'
          );
        } else {
          log(
            'e2eResult',
            '‚ùå NEEDS WORK: Significant issues found, requires attention.'
          );
        }
      }

      function clearLogs() {
        document
          .querySelectorAll('.log')
          .forEach((log) => (log.textContent = ''));
        testResults = { total: 0, passed: 0, failed: 0 };
        updateTestSummary();
      }

      // Initialize on page load
      window.onload = function () {
        initializeSupabase();
      };
    </script>
  </body>
</html>
